@using FlowSynx.Client.Messages.Requests.Plugins
@using FlowSynx.Client.Messages.Requests.Workflows
@using FlowSynx.Client.Messages.Responses.Plugins
@using MudBlazor

@attribute [Authorize]
@inject IAccessTokenProvider TokenProvider
@inject IFlowSynxClient FlowSynxClient
@inject ISnackbar SnackBar

<MudDialog MaxWidth="MaxWidth.Medium"
           FullWidth="true"
           DisableBackdropClick="@IsProcessing"
           CloseOnEscapeKey="false">

    <DialogContent>

        <MudCard Elevation="0" Class="rounded-xl">

            <!-- Body -->
            <MudCardContent Class="pt-4">

                <!-- Trigger basics -->
                <MudGrid Spacing="3">

                    <MudItem xs="12" md="6">
                        <MudSelect T="string"
                                   Label="Trigger Type"
                                   @bind-Value="UpdateWorkflowTriggerRequest.Type"
                                   Variant="Variant.Filled"
                                   StartIcon="@Icons.Material.Filled.Category"
                                   Disabled="@IsProcessing">
                            @foreach (var triggerType in Enum.GetValues<WorkflowTriggerType>())
                            {
                                <MudSelectItem Value="@triggerType.ToString()">
                                    @triggerType
                                </MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" md="6" Class="d-flex align-center">
                        <MudSwitch @bind-Value="UpdateWorkflowTriggerRequest.Status"
                                   Converter="_statusConverter"
                                   Label="Trigger Active"
                                   Color="Color.Primary"
                                   Disabled="@IsProcessing" />
                    </MudItem>

                </MudGrid>

                <MudDivider Class="my-4" />

                <!-- Properties -->
                <MudText Typo="Typo.h6" Class="mb-2">
                    Trigger Properties
                </MudText>

                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                    Modify the key–value parameters used by this trigger.
                </MudText>

                <MudTable Items="Properties"
                          Dense="true"
                          Hover="true"
                          Breakpoint="Breakpoint.Sm">

                    <ToolBarContent>
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   Disabled="@IsProcessing"
                                   OnClick="AddProperty">
                            Add Property
                        </MudButton>
                    </ToolBarContent>

                    <HeaderContent>
                        <MudTh>Key</MudTh>
                        <MudTh>Value</MudTh>
                        <MudTh></MudTh>
                    </HeaderContent>

                    <RowTemplate>
                        <MudTd>
                            <MudTextField @bind-Value="context.Key"
                                          Variant="Variant.Filled"
                                          Placeholder="Key"
                                          Margin="Margin.Dense"
                                          Disabled="@IsProcessing" />
                        </MudTd>

                        <MudTd>
                            <MudTextField @bind-Value="context.Value"
                                          Variant="Variant.Filled"
                                          Placeholder="Value"
                                          Margin="Margin.Dense"
                                          Disabled="@IsProcessing" />
                        </MudTd>

                        <MudTd Align="Align.Right">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error"
                                           Disabled="@IsProcessing"
                                           OnClick="@(() => DeleteProperty(context.Id))" />
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText>No properties defined.</MudText>
                    </NoRecordsContent>
                    <LoadingContent>
                        <MudText>Loading...</MudText>
                    </LoadingContent>
                </MudTable>

            </MudCardContent>

            <!-- Footer -->
            <MudDivider />

            <MudCardActions Class="pa-4 d-flex justify-end gap-2">

                <MudButton Variant="Variant.Text"
                           Color="Color.Default"
                           Disabled="@IsProcessing"
                           OnClick="Cancel">
                    Cancel
                </MudButton>

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Disabled="@IsProcessing"
                           OnClick="Update"
                           StartIcon="@Icons.Material.Filled.Save">

                    @if (IsProcessing)
                    {
                        <MudProgressCircular Indeterminate="true"
                                             Size="Size.Small"
                                             Class="mr-2" />
                        <span>Updating…</span>
                    }
                    else
                    {
                        <span>Update Trigger</span>
                    }
                </MudButton>

            </MudCardActions>

        </MudCard>

    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public Guid WorkflowId { get; set; }

    [Parameter]
    public Guid TriggerId { get; set; }

    private bool IsProcessing = false;
    private List<TempKeyValue> Properties = new List<TempKeyValue>();
    private UpdateWorkflowTriggerRequest UpdateWorkflowTriggerRequest = new()
    {
        WorkflowId = Guid.Empty,
        TriggerId = Guid.Empty,
        Status = WorkflowTriggerStatus.Active.ToString(),
        Type = WorkflowTriggerType.Time.ToString(),
        Properties = new()
    };

    private readonly MudBlazor.Converter<string, bool?> _statusConverter = new()
    {
        SetFunc = status => status == WorkflowTriggerStatus.Active.ToString(),
        GetFunc = isActive => isActive == true ?
                                          WorkflowTriggerStatus.Active.ToString() :
                                          WorkflowTriggerStatus.DeActive.ToString()
    };

    protected override async Task OnInitializedAsync()
    {
        await GetDetails();
    }

    private async Task GetDetails()
    {
        try
        {
            IsProcessing = true;
            string? token;
            var accessTokenResult = await TokenProvider.GetAccessTokenAsync();

            if (string.IsNullOrEmpty(accessTokenResult))
                token = "No token available or user not authenticated.";
            else
                token = accessTokenResult;

            var authenticationStrategy = new FlowSynx.Client.Authentication.BearerTokenAuthStrategy(token);
            FlowSynxClient.SetAuthenticationStrategy(authenticationStrategy);

            var workflowTriggerDetailsRequest = new WorkflowTriggerDetailsRequest()
            {
                WorkflowId = WorkflowId,
                TriggerId = TriggerId
            };
            var result = await FlowSynxClient.Workflows.TriggerDetailsAsync(workflowTriggerDetailsRequest);
            if (result.StatusCode != 200)
            {
                SnackBar.Add("Server error while processing the request.", Severity.Error);
                return;
            }

            var payload = result.Payload;
            if (!payload.Succeeded)
            {
                foreach (var message in result.Payload.Messages)
                    SnackBar.Add($"Update workflow trigger error:\n{message}", Severity.Error);

                return;
            }
            else
            {
                UpdateWorkflowTriggerRequest = new UpdateWorkflowTriggerRequest
                {
                    WorkflowId = WorkflowId,
                    TriggerId = payload.Data.Id,
                    Status = payload.Data.Status ?? WorkflowTriggerStatus.Active.ToString(),
                    Type = payload.Data.Type ?? WorkflowTriggerType.Time.ToString()
                };

                if (payload.Data.Properties == null)
                {
                    Properties = new List<TempKeyValue>();
                }
                else
                {
                    Properties = payload.Data.Properties.Select(spec => new TempKeyValue
                    {
                        Id = Guid.NewGuid(),
                        Key = spec.Key,
                        Value = spec.Value.ToString()
                    }).ToList();
                }
            }
        }
        catch (Exception ex)
        {
            SnackBar.Add($"Unexpected error: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private void BackdropHandler(MouseEventArgs e)
    {
        if (!IsProcessing)
            MudDialog.Cancel();
    }

    private void KeyHandler(KeyboardEventArgs e)
    {
        if (e.Key == "Escape" && !IsProcessing)
            MudDialog.Cancel();
    }

    void AddProperty()
    {
        Properties.Add(new TempKeyValue() { Id = Guid.NewGuid() });
    }

    void DeleteProperty(Guid id)
    {
        var item = Properties.FirstOrDefault(x => x.Id == id);
        if (item != null)
            Properties.Remove(item);
    }

    private async Task Update()
    {
        try
        {
            IsProcessing = true;
            string? token;
            var accessTokenResult = await TokenProvider.GetAccessTokenAsync();

            if (string.IsNullOrEmpty(accessTokenResult))
                token = "No token available or user not authenticated.";
            else
                token = accessTokenResult;

            var authenticationStrategy = new FlowSynx.Client.Authentication.BearerTokenAuthStrategy(token);
            FlowSynxClient.SetAuthenticationStrategy(authenticationStrategy);

            UpdateWorkflowTriggerRequest.WorkflowId = WorkflowId;
            if (Properties.Any())
            {
                Dictionary<string, object> objDict = new Dictionary<string, object>();
                foreach (var item in Properties)
                {
                    if (!objDict.ContainsKey(item.Key))
                        objDict.Add(item.Key, item.Value);
                }

                UpdateWorkflowTriggerRequest.Properties = objDict;
            }
            else
            {
                UpdateWorkflowTriggerRequest.Properties = new();
            }

            var result = await FlowSynxClient.Workflows.UpdateTriggerAsync(UpdateWorkflowTriggerRequest);
            if (result.StatusCode != 200)
            {
                SnackBar.Add("Server error while processing the request.", Severity.Error);
                return;
            }

            var payload = result.Payload;
            if (!payload.Succeeded)
            {
                foreach (var message in payload.Messages)
                    SnackBar.Add($"Update workflow trigger error:\n{message}", Severity.Error);

                return;
            }
            else
            {
                SnackBar.Add("Workdlow trigger updated successfully!", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
        }
        catch (Exception ex)
        {
            SnackBar.Add($"Unexpected error: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private class TempKeyValue
    {
        public Guid Id { get; set; }
        public string Key { get; set; } = string.Empty;
        public string? Value { get; set; }
    }

    private enum WorkflowTriggerType
    {
        Time
    }

    private enum WorkflowTriggerStatus
    {
        Active = 0,
        DeActive = 1
    }
}