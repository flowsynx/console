@page "/workflows/{id:guid}/manage"
@using Console.Components.Pages.Triggers
@using FlowSynx.Client.Messages.Requests.Workflows
@using FlowSynx.Client.Messages.Responses.Workflows
@inject IWorkflowService WorkflowService
@inject IJSRuntime JSRuntime

@attribute [Authorize]
@inject IAccessTokenProvider TokenProvider
@inject IFlowSynxClient FlowSynxClient
@inject ISnackbar SnackBar
@inject IDialogService DialogService
@inject NavigationManager Navigation

<PageTitle>FlowSynx manage workflow</PageTitle>

<HeaderTitle Title="Workflow designer"
             Description="A visual interface to create, edit, and manage workflow."
             Icon="@Icons.Material.Filled.DesignServices"
             IconColor="Color.Primary"
             IconSize="Size.Large" />

<MudTabs Position="Position.Top"
         Rounded="true"
         Class="modern-tabs mb-4">


    <!-- DESIGNER TAB -->
    <MudTabPanel Text="Designer"
                 Icon="@Icons.Material.Filled.AccountTree"
                 Disabled="@IsProcessing">


        <!-- Floating Action Bar -->
        <MudPaper Elevation="2" Class="action-bar glass">
            <MudStack Row AlignItems="AlignItems.Center" Spacing="1">


                <!-- Primary: Save -->
                <MudTooltip Text="Save workflow">
                    <MudIconButton Icon="@Icons.Material.Filled.Save"
                                   Color="Color.Primary"
                                   Disabled="@IsProcessing"
                                   Size="Size.Medium"
                                   OnClick="Save" />
                </MudTooltip>


                <MudDivider Vertical Class="mx-1" />


                <!-- Toggle View -->
                <MudTooltip Text="@(CurrentView == View.Code ? "Switch to Designer" : "Switch to JSON")">
                    <MudIconButton Icon="@(CurrentView == View.Code
                                   ? Icons.Material.Filled.DesignServices
                                   : Icons.Material.Filled.Code)"
                                   Color="Color.Default"
                                   Disabled="@IsProcessing"
                                   Size="Size.Medium"
                                   OnClick="ToggleCodeDesigner" />
                </MudTooltip>


                <!-- Configure -->
                @if (CurrentView == View.Designer)
                {
                    <MudTooltip Text="Configure workflow">
                        <MudIconButton Icon="@Icons.Material.Filled.Settings"
                                       Color="Color.Default"
                                       Disabled="@IsProcessing"
                                       Size="Size.Medium"
                                       OnClick="ConfigureWorkflow" />
                    </MudTooltip>
                }


                <MudSpacer />


                <!-- Destructive & Run Actions (Grouped Right) -->
                <MudStack Row Spacing="0">
                    <MudTooltip Text="Delete workflow">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Color="Color.Error"
                                       Disabled="@IsProcessing"
                                       Size="Size.Medium"
                                       OnClick="DeleteWorkflow" />
                    </MudTooltip>


                    <MudTooltip Text="Execute workflow">
                        <MudIconButton Icon="@Icons.Material.Filled.PlayArrow"
                                       Color="Color.Success"
                                       Disabled="@IsProcessing"
                                       Size="Size.Medium"
                                       OnClick="ExecuteWorkflow" />
                    </MudTooltip>
                </MudStack>

                <!-- View Indicator -->
                <MudChip T="string" Color="Color.Primary"
                         Variant="Variant.Outlined"
                         StartIcon="@(CurrentView == View.Code ? Icons.Material.Filled.Code : Icons.Material.Filled.DesignServices)">
                    @(CurrentView == View.Code ? "JSON" : "Designer")
                </MudChip>
            </MudStack>
        </MudPaper>


        <!-- Content -->
        <MudPaper Class="designer-content" Elevation="1">
            @RenderCurrentView()
        </MudPaper>
    </MudTabPanel>


    <!-- EXECUTIONS TAB -->
    <MudTabPanel Text="Executions"
                 Icon="@Icons.Material.Filled.PlayArrow"
                 Disabled="@IsProcessing">
        <WorkflowExecutions WorkflowId="@id" />
    </MudTabPanel>


    <!-- TRIGGERS TAB -->
    <MudTabPanel Text="Triggers"
                 Icon="@Icons.Material.Filled.Bolt"
                 Disabled="@IsProcessing">
        <WorkflowTriggers WorkflowId="@id" />
    </MudTabPanel>
</MudTabs>

@code {
    [Parameter]
    public Guid id { get; set; }

    private bool IsProcessing = false;
    private WorkflowContainer WorkflowContainer { get; set; } = new WorkflowContainer();
    private string? _workflowJson;
    private UpdateWorkflowRequest UpdateWorkflowRequest = new UpdateWorkflowRequest
            {
                Id = Guid.Empty,
                Definition = ""
            };

    protected override async Task OnInitializedAsync()
    {
        await LoadWorkflow();
    }

    private async Task LoadWorkflow()
    {
        try
        {
            IsProcessing = true;
            var accessTokenResult = await TokenProvider.GetAccessTokenAsync();
            if (string.IsNullOrEmpty(accessTokenResult))
            {
                SnackBar.Add("No token available or user not authenticated.", Severity.Error);
                Navigation.NavigateTo("/workflows");
            }
            var authenticationStrategy = new FlowSynx.Client.Authentication.BearerTokenAuthStrategy(accessTokenResult);

            FlowSynxClient.SetAuthenticationStrategy(authenticationStrategy);
            var workflowResult = await FlowSynxClient.Workflows.DetailsAsync(new WorkflowDetailsRequest { Id = id });

            if (workflowResult.StatusCode != 200)
            {
                SnackBar.Add("Server error while fetching the workflow.", Severity.Error);
                Navigation.NavigateTo("/workflows");
            }
            var payload = workflowResult.Payload;
            if (!payload.Succeeded)
            {
                foreach (var message in payload.Messages)
                    SnackBar.Add($"Get workflow error:\n{message}", Severity.Error);

                Navigation.NavigateTo("/workflows");
            }

            _workflowJson = payload.Data.Workflow;

            // var workflowContainer = new WorkflowContainer
            //     {
            //         Schema = payload.Data.sc,
            //         Workflow = payload.Data.Workflow
            //     };


            WorkflowService.SetJson(_workflowJson);
            WorkflowContainer = WorkflowService.Get();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            SnackBar.Add($"Unexpected error: {ex.Message}", Severity.Error);
            Navigation.NavigateTo("/workflows");
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private View CurrentView { get; set; } = View.Designer;

    private void SwitchView(View view)
    {
        CurrentView = view;
    }

    private RenderFragment RenderCurrentView() => CurrentView switch
    {
        View.Code => @<WorkflowJsonEditor JsonContent="@_workflowJson"
                    JsonContentChanged="v => _workflowJson = v" />,
        View.Designer => WorkflowContainer is not null && WorkflowContainer.Workflow.Tasks?.Any() == true
                ? @<WorkflowDesigner WorkflowContainer="@WorkflowContainer" />
                : @<MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary" />,
        _ => @<p>Unknown view</p>
    };

    private void ToggleCodeDesigner()
    {
        CurrentView = CurrentView == View.Code ? View.Designer : View.Code;
        if (CurrentView == View.Code)
        {
            _workflowJson = WorkflowService.GetJson();
        }
        else
        {
            if (!string.IsNullOrWhiteSpace(_workflowJson))
            {
                WorkflowService.SetJson(_workflowJson);
            }
        }
    }

    private async Task Save()
    {
        try
        {
            IsProcessing = true;
            string? token;
            var accessTokenResult = await TokenProvider.GetAccessTokenAsync();

            if (string.IsNullOrEmpty(accessTokenResult))
                token = "No token available or user not authenticated.";
            else
                token = accessTokenResult;

            var authenticationStrategy = new FlowSynx.Client.Authentication.BearerTokenAuthStrategy(token);
            FlowSynxClient.SetAuthenticationStrategy(authenticationStrategy);

            if (CurrentView == View.Code)
            {
                if (string.IsNullOrWhiteSpace(_workflowJson))
                {
                    SnackBar.Add("Please provide a valid JSON definition.", Severity.Error);
                    return;
                }
                UpdateWorkflowRequest.Definition = _workflowJson;
            }
            else
            {
                UpdateWorkflowRequest.Definition = WorkflowService.GetJson();
            }

            UpdateWorkflowRequest.Id = id;

            var result = await FlowSynxClient.Workflows.UpdateAsync(UpdateWorkflowRequest);
            if (result.StatusCode != 200)
            {
                SnackBar.Add("Server error while processing the request.", Severity.Error);
                return;
            }

            var payload = result.Payload;
            if (!payload.Succeeded)
            {
                foreach (var message in result.Payload.Messages)
                    SnackBar.Add($"Update workflow error:\n{message}", Severity.Error);

                return;
            }
            else
            {
                SnackBar.Add("Workflow updated successfully!", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            SnackBar.Add($"Unexpected error: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private async Task ConfigureWorkflow()
    {
        var options = new DialogOptions
            {
                CloseButton = false,
                MaxWidth = MaxWidth.Small,
                BackdropClick = false,
                CloseOnEscapeKey = false,
                BackgroundClass = "blur-dialog-background"
            };

        var parameters = new DialogParameters
        {
            {
                "Config", new WorkflowViewModel
                {
                    Name = WorkflowContainer.Workflow.Name,
                    Description = WorkflowContainer.Workflow.Description,
                    Configuration = WorkflowContainer.Workflow.Configuration
                }
            }
        };

        var dialog = await DialogService.ShowAsync<ConfigureWorkflowDialog>("Configure workflow", parameters, options);
        var dialogResult = await dialog.Result;
        if (dialogResult != null && !dialogResult.Canceled)
        {
            var result = (WorkflowViewModel)dialogResult.Data;
            WorkflowContainer.Workflow.Name = result.Name;
            WorkflowContainer.Workflow.Description = result.Description;
            WorkflowContainer.Workflow.Configuration = result.Configuration;
        }
    }

    private async Task DeleteWorkflow()
    {
        var options = new DialogOptions
            {
                CloseButton = false,
                MaxWidth = MaxWidth.Small,
                BackdropClick = false,
                CloseOnEscapeKey = false,
                BackgroundClass = "blur-dialog-background"
            };

        var parameters = new DialogParameters {
            { "Id", id },
            { "WorkflowName", WorkflowContainer.Workflow.Name },
            { "WorkflowDescription", WorkflowContainer.Workflow.Description }
        };

        var dialog = await DialogService.ShowAsync<DeleteWorkflowDialog>("Delete workflow", parameters, options);
        var dialogResult = await dialog.Result;
        if (dialogResult != null && !dialogResult.Canceled)
            Navigation.NavigateTo("/workflows");
    }

    private async Task ExecuteWorkflow()
    {
        try
        {
            var accessTokenResult = await TokenProvider.GetAccessTokenAsync();

            string? token;
            if (string.IsNullOrEmpty(accessTokenResult))
                token = "No token available or user not authenticated.";
            else
                token = accessTokenResult;

            var authenticationStrategy = new FlowSynx.Client.Authentication.BearerTokenAuthStrategy(token);
            FlowSynxClient.SetAuthenticationStrategy(authenticationStrategy);

            var request = new ExecuteWorkflowRequest { WorkflowId = id };
            var result = await FlowSynxClient.Workflows.ExecuteAsync(request);

            if (result.StatusCode != 200)
            {
                SnackBar.Add("Failed to execute workflow: Bad response code.", Severity.Error);
                return;
            }

            if (!result.Payload.Succeeded)
            {
                var errorMessage = string.Join(Environment.NewLine, result.Payload.Messages);
                SnackBar.Add($"Execute workflow error:\n{errorMessage}", Severity.Error);
                return;
            }
        }
        catch (Exception ex)
        {
            SnackBar.Add($"Exception occurred: {ex.Message}", Severity.Error);
            return;
        }
    }

    private enum View
    {
        Code,
        Designer
    }
}