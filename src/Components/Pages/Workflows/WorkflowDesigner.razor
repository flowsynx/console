@using Microsoft.AspNetCore.Components
@using System.Text.Json
@implements IAsyncDisposable

@inject IJSRuntime JSRuntime
@inject IDialogService DialogService

<div class="designer-root">
    <div class="palette-container">
        <MudTooltip Text="@(IsPaletteVisible ? "Close panel" : "Open panel and add plugins")">
            <MudIconButton Variant="Variant.Filled"
            Size="Size.Medium"
            Icon="@(IsPaletteVisible ? Icons.Material.Filled.Close : Icons.Material.Filled.Add)"
            Color="Color.Primary"
            Class="palette-toggle"
            OnClick="TogglePalette" />
        </MudTooltip>

        <!-- Palette -->
        <div class="palette @(IsPaletteVisible ? "visible" : "hidden")">
            <HeaderTitle Title="Plugins" Class="px-2 py-2" />
            <SearchablePluginsList OnItemClick="AddNodeTemplate" />
        </div>
    </div>

    <!-- Canvas -->
    <div class="canvas-wrap">
        <div class="canvas-toolbar">
            <MudIconButton Variant="Variant.Text"
            Size="Size.Medium"
            Icon="@Icons.Material.Filled.ZoomIn"
            OnClick="ZoomIn" />

            <MudIconButton Variant="Variant.Text"
            Size="Size.Medium"
            Icon="@Icons.Material.Filled.ZoomOut"
            OnClick="ZoomOut" />

            <MudIconButton Variant="Variant.Text"
            Size="Size.Medium"
            Icon="@Icons.Material.Filled.Refresh"
            OnClick="ZoomReset" />

            <MudIconButton Variant="Variant.Text"
            Size="Size.Medium"
            Icon="@Icons.Material.Filled.FilterCenterFocus"
            OnClick="Center" />
        </div>
        <div id="drawflow" style="height:100%;"></div>
    </div>
</div>

@code {
    [Parameter] public WorkflowContainer WorkflowContainer { get; set; }

    private WorkflowTask SelectedTask;
    private string _deps;
    private string _newKey;
    private string _newValue;
    private DotNetObjectReference<WorkflowDesigner> _selfRef;
    private bool IsPaletteVisible = false;

    private void TogglePalette()
    {
        IsPaletteVisible = !IsPaletteVisible;
    }

    private Task ZoomIn() => JSRuntime.InvokeVoidAsync("fsDrawflow.zoomIn").AsTask();
    private Task ZoomOut() => JSRuntime.InvokeVoidAsync("fsDrawflow.zoomOut").AsTask();
    private Task ZoomReset() => JSRuntime.InvokeVoidAsync("fsDrawflow.zoomReset").AsTask();
    private Task Center() => JSRuntime.InvokeVoidAsync("fsDrawflow.center").AsTask();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _selfRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("fsDrawflow.init", "drawflow", _selfRef);
            await LoadWorkflowIntoCanvas();
        }
    }

    private async Task LoadWorkflowIntoCanvas()
    {
        await JSRuntime.InvokeVoidAsync("fsDrawflow.clear");

        foreach (var task in WorkflowContainer.Workflow.Tasks)
        {
            string displayType;

            if (task.Type is JsonElement json)
            {
                if (json.ValueKind == JsonValueKind.String)
                {
                    displayType = json.GetString() ?? "";
                }
                else if (json.ValueKind == JsonValueKind.Object)
                {
                    string? plugin = json.TryGetProperty("Plugin", out var pluginProp) ? pluginProp.GetString() : null;
                    string? version = json.TryGetProperty("Version", out var versionProp) ? versionProp.GetString() : null;

                    displayType = !string.IsNullOrWhiteSpace(plugin) && !string.IsNullOrWhiteSpace(version)
                        ? $"{plugin} ({version})"
                        : plugin ?? "Unknown";
                }
                else
                {
                    displayType = "Unknown";
                }
            }
            else if (task.Type != null)
            {
                var pluginProp = task.Type.GetType().GetProperty("Plugin")?.GetValue(task.Type)?.ToString();
                var versionProp = task.Type.GetType().GetProperty("Version")?.GetValue(task.Type)?.ToString();

                displayType = !string.IsNullOrWhiteSpace(pluginProp) && !string.IsNullOrWhiteSpace(versionProp)
                    ? $"{pluginProp} ({versionProp})"
                    : pluginProp ?? "Unknown";
            }
            else
            {
                displayType = "Unknown";
            }

            var data = new
            {
                name = task.Name,
                type = displayType,
                parameters = task.Execution.Parameters
            };

            var id = await JSRuntime.InvokeAsync<int>(
                "fsDrawflow.addNode",
                task.Name,
                data,
                (double)(task.Position.X == 0 ? 100 : task.Position.X),
                (double)(task.Position.Y == 0 ? 100 : task.Position.Y)
            );
            task.NodeId = id.ToString();
        }

        foreach (var t in WorkflowContainer.Workflow.Tasks)
        {
            foreach (var dep in t.FlowControl.Dependencies)
            {
                var from = WorkflowContainer.Workflow.Tasks.FirstOrDefault(x => x.Name == dep);
                if (from != null)
                    await JSRuntime.InvokeVoidAsync("fsDrawflow.connect", from.NodeId, t.NodeId);
            }
        }
    }

    private async Task AddNodeTemplate((string type, string version) plugin)
    {
        var typeValue = plugin.type == "LocalFileSystem"
            ? (object)""
            : new
            {
                Plugin = plugin.type,
                Version = plugin.version,
                Specifications = new Dictionary<string, string>()
            };

        var newTask = new WorkflowTask
            {
            Name = $"{plugin.type}-{WorkflowContainer.Workflow.Tasks.Count + 1}",
                Type = typeValue,
                Position = new(
                    120 + (WorkflowContainer.Workflow.Tasks.Count % 5) * 140,
                    120 + (WorkflowContainer.Workflow.Tasks.Count / 5) * 120
                )
            };

        WorkflowContainer.Workflow.Tasks.Add(newTask);

        string displayType = plugin.type == "LocalFileSystem"
            ? ""
            : $"{plugin.type} ({plugin.version})";

        var data = new
        {
            name = newTask.Name,
            type = displayType,
            parameters = newTask.Execution.Parameters
        };

        var id = await JSRuntime.InvokeAsync<int>(
            "fsDrawflow.addNode",
            newTask.Name,
            data,
            (double)newTask.Position.X,
            (double)newTask.Position.Y
        );

        newTask.NodeId = id.ToString();
        StateHasChanged();
    }

    private void SetParam(string key, string value) => SelectedTask.Execution.Parameters[key] = value;
    private void RemoveParam(string key) => SelectedTask.Execution.Parameters.Remove(key);
    private void AddParam()
    {
        if (!string.IsNullOrWhiteSpace(_newKey))
        {
            SelectedTask.Execution.Parameters[_newKey] = _newValue;
            _newKey = _newValue = null;
        }
    }

    private Task UpdateNodeTitle() =>
        SelectedTask != null ? JSRuntime.InvokeVoidAsync("fsDrawflow.updateNodeTitle", SelectedTask.NodeId, SelectedTask.Name, SelectedTask.Type ?? "LocalFileSystem").AsTask() : Task.CompletedTask;

    private async void ShowPropertiesDialog(WorkflowTask task)
    {
        var options = new DialogOptions
            {
                CloseButton = false,
                MaxWidth = MaxWidth.Small,
                BackdropClick = false,
                CloseOnEscapeKey = false,
                BackgroundClass = "blur-dialog-background"
            };

        var parameters = new DialogParameters
            {
                ["SelectedTask"] = task,
                ["OnUpdated"] = EventCallback.Factory.Create(this, async () =>
                {
                    await UpdateNodeTitle();
                    StateHasChanged();
                })
            };

        await DialogService.ShowAsync<WorkflowNodeProperties>("Properties", parameters, options);
    }

    private void UpdateDepsFromText() =>
        SelectedTask.FlowControl.Dependencies = _deps?.Split(',').Select(s => s.Trim()).Where(s => !string.IsNullOrWhiteSpace(s)).ToList() ?? new();

    [JSInvokable]
    public Task OnNodeSelected(string id)
    {
        SelectedTask = WorkflowContainer.Workflow.Tasks.FirstOrDefault(x => x.NodeId == id);
        _deps = SelectedTask != null ? string.Join(',', SelectedTask.FlowControl.Dependencies) : string.Empty;
        StateHasChanged();
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnNodeUnselected() { SelectedTask = null; StateHasChanged(); return Task.CompletedTask; }

    [JSInvokable]
    public Task OnConnectionCreated(string fromId, string toId)
    {
        var from = WorkflowContainer.Workflow.Tasks.FirstOrDefault(x => x.NodeId == fromId);
        var to = WorkflowContainer.Workflow.Tasks.FirstOrDefault(x => x.NodeId == toId);
        if (from != null && to != null && !to.FlowControl.Dependencies.Contains(from.Name))
            to.FlowControl.Dependencies.Add(from.Name);
        _deps = SelectedTask == to ? string.Join(',', to.FlowControl.Dependencies) : _deps;
        StateHasChanged();
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnConnectionRemoved(string fromId, string toId)
    {
        var from = WorkflowContainer.Workflow.Tasks.FirstOrDefault(x => x.NodeId == fromId);
        var to = WorkflowContainer.Workflow.Tasks.FirstOrDefault(x => x.NodeId == toId);
        to?.FlowControl.Dependencies.Remove(from?.Name);
        _deps = SelectedTask == to ? string.Join(',', to.FlowControl.Dependencies) : _deps;
        StateHasChanged();
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnNodeRemoved(string id)
    {
        var t = WorkflowContainer.Workflow.Tasks.FirstOrDefault(x => x.NodeId == id);
        if (t != null)
        {
            WorkflowContainer.Workflow.Tasks.Remove(t);
            foreach (var o in WorkflowContainer.Workflow.Tasks) o.FlowControl.Dependencies.Remove(t.Name);
            if (SelectedTask == t) { SelectedTask = null; _deps = string.Empty; }
        }
        StateHasChanged();
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnNodeDoubleClicked(string id)
    {
        var task = WorkflowContainer.Workflow.Tasks.FirstOrDefault(x => x.NodeId == id);
        if (task != null)
        {
            SelectedTask = task;
            ShowPropertiesDialog(task);
        }
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnNodeProperties(string id)
    {
        var task = WorkflowContainer.Workflow.Tasks.FirstOrDefault(x => x.NodeId == id);
        if (task != null)
        {
            SelectedTask = task;
            ShowPropertiesDialog(task);
        }
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnNodeMoved(string id, double? x, double? y)
    {
        var task = WorkflowContainer.Workflow.Tasks.FirstOrDefault(t => t.NodeId == id);
        if (task != null && x.HasValue && y.HasValue)
        {
            task.Position = new((int)x.Value, (int)y.Value);
            StateHasChanged();
        }
        return Task.CompletedTask;
    }

    public ValueTask DisposeAsync()
    {
        _selfRef?.Dispose();
        return ValueTask.CompletedTask;
    }
}