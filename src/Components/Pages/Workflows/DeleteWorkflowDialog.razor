@using FlowSynx.Client.Messages.Requests.Plugins
@using FlowSynx.Client.Messages.Requests.Workflows

@attribute [Authorize]
@inject IAccessTokenProvider TokenProvider
@inject IFlowSynxClient FlowSynxClient
@inject ISnackbar SnackBar

<MudDialog MaxWidth="MaxWidth.Small"
           FullWidth="true"
           DisableBackdropClick="@IsProcessing"
           CloseOnEscapeKey="false">

    <DialogContent>

        <MudCard Elevation="0" Class="rounded-xl">

            <!-- Body -->
            <MudCardContent Class="pt-4">

                <MudAlert Severity="Severity.Warning"
                          Variant="Variant.Outlined"
                          Dense="false"
                          Class="mb-4">
                    <MudText Typo="Typo.body1"><b>This action is permanent and cannot be undone.</b></MudText>
                    <MudText Typo="Typo.subtitle2">Consider exporting or duplicating this workflow before deletion.</MudText>
                </MudAlert>

                <!-- Workflow identity -->
                <MudPaper Outlined="true" Class="pa-4 rounded-lg mb-4">
                    <MudText Typo="Typo.subtitle2" Class="mb-1">
                        Workflow
                    </MudText>

                    <MudText Typo="Typo.h6">@WorkflowName</MudText>

                    @if (!string.IsNullOrWhiteSpace(WorkflowDescription))
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-1">
                            @WorkflowDescription
                        </MudText>
                    }
                </MudPaper>

                <!-- Impact -->
                <MudPaper Outlined="true" Class="pa-4 rounded-lg">
                    <MudText Typo="Typo.subtitle2" Color="Color.Warning" Class="mb-2">
                        <b>⚠️ What will be removed?</b>
                    </MudText>

                    <MudList T="string" Dense="true" ReadOnly="true" Gutters="false">
                        <MudListItem>
                            <MudIcon Icon="@Icons.Material.Filled.Delete"
                                     Color="Color.Secondary"
                                     Class="mr-2" />
                            Workflow definition
                        </MudListItem>

                        <MudListItem>
                            <MudIcon Icon="@Icons.Material.Filled.History"
                                     Color="Color.Secondary"
                                     Class="mr-2" />
                            Execution history and logs
                        </MudListItem>

                        <MudListItem>
                            <MudIcon Icon="@Icons.Material.Filled.Bolt"
                                     Color="Color.Secondary"
                                     Class="mr-2" />
                            Triggers and schedules
                        </MudListItem>

                        <MudListItem>
                            <MudIcon Icon="@Icons.Material.Filled.Block"
                                     Color="Color.Secondary"
                                     Class="mr-2" />
                            Dependent processes will stop working
                        </MudListItem>
                    </MudList>
                </MudPaper>

            </MudCardContent>

            <!-- Footer -->
            <MudDivider />

            <MudCardActions Class="pa-4 d-flex justify-end gap-2">

                <MudButton Variant="Variant.Text"
                           Color="Color.Default"
                           Disabled="@IsProcessing"
                           OnClick="Cancel">
                    Cancel
                </MudButton>

                <MudButton Variant="Variant.Filled"
                           Color="Color.Error"
                           Disabled="@IsProcessing"
                           OnClick="Delete"
                           StartIcon="@Icons.Material.Filled.DeleteForever">

                    @if (IsProcessing)
                    {
                        <MudProgressCircular Indeterminate="true"
                                             Size="Size.Small"
                                             Class="mr-2" />
                        <span>Deleting...</span>
                    }
                    else
                    {
                        <span>Delete Workflow</span>
                    }
                </MudButton>

            </MudCardActions>

        </MudCard>

    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public Guid Id { get; set; } = Guid.Empty;

    [Parameter]
    public string WorkflowName { get; set; } = "";

    [Parameter]
    public string? WorkflowDescription { get; set; } = "";

    private bool IsProcessing = false;

    private void Cancel() => MudDialog.Cancel();

    private void BackdropHandler(MouseEventArgs e)
    {
        if (!IsProcessing)
            MudDialog.Cancel();
    }

    private void KeyHandler(KeyboardEventArgs e)
    {
        if (e.Key == "Escape" && !IsProcessing)
            MudDialog.Cancel();
    }

    private async Task Delete()
    {
        try
        {
            IsProcessing = true;
            string? token;
            var accessTokenResult = await TokenProvider.GetAccessTokenAsync();

            if (string.IsNullOrEmpty(accessTokenResult))
                token = "No token available or user not authenticated.";
            else
                token = accessTokenResult;

            var authenticationStrategy = new FlowSynx.Client.Authentication.BearerTokenAuthStrategy(token);
            FlowSynxClient.SetAuthenticationStrategy(authenticationStrategy);

            var deletePluginConfigRequest = new DeleteWorkflowRequest() { Id = Id };
            var result = await FlowSynxClient.Workflows.DeleteAsync(deletePluginConfigRequest);
            if (result.StatusCode != 200)
            {
                SnackBar.Add("Server error while processing the request.", Severity.Error);
                return;
            }

            var payload = result.Payload;
            if (!payload.Succeeded)
            {
                foreach (var message in result.Payload.Messages)
                    SnackBar.Add($"Delete workflow error:\n{message}", Severity.Error);

                return;
            }
            else
            {
                SnackBar.Add("Workflow deleted successfully!", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
        }
        catch (Exception ex)
        {
            SnackBar.Add($"Unexpected error: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsProcessing = false;
        }
    }
}