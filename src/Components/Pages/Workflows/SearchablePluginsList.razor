@using Console.Models
@using FlowSynx.Client.Messages.Responses.Plugins
@attribute [Authorize]
@inject IAccessTokenProvider TokenProvider
@inject IFlowSynxClient FlowSynxClient
@inject ISnackbar SnackBar

<MudPaper Elevation="0">
    <!-- Header -->
    <MudStack Spacing="2">
        <!-- Search -->
        <MudTextField @bind-Value="_search"
                      Placeholder="Search by plugin or version"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Immediate="true"
                      DebounceInterval="200"
                      Clearable="true"
                      Variant="Variant.Outlined"
                      Class="rounded-xl" />

        <!-- Loading state -->
        @if (_loading)
        {
            <MudSkeleton Height="48px" />
            <MudSkeleton Height="48px" />
            <MudSkeleton Height="48px" />
        }
        else if (FilteredItems.Count == 0)
        {
            <!-- Empty state -->
            <MudPaper Class="pa-6 text-center rounded-xl" Elevation="0">
                <MudIcon Icon="@Icons.Material.Filled.ExtensionOff" Size="Size.Large" Style="@($"color:{Colors.Gray.Default};")" />
                <MudText Typo="Typo.subtitle1" Class="mt-2">No plugins found</MudText>
                <MudText Typo="Typo.body2" Style="@($"color:{Colors.Gray.Default};")">
                    Try adjusting your search
                </MudText>
            </MudPaper>
        }
        else
        {
            <!-- Plugin cards -->
            <MudGrid>
                @foreach (var item in FilteredItems)
                {
                    <MudItem xs="12" sm="12" md="12">
                        <MudCard Class="rounded-2xl h-100 hover-card" Elevation="1">
                            <MudCardHeader>
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.subtitle1" Class="fw-600">
                                        @item.Type
                                    </MudText>
                                    <MudText Typo="Typo.caption" Style="@($"color:{Colors.Gray.Default};")">
                                        @item.Versions.Count version(s)
                                    </MudText>
                                </MudStack>
                                <MudSpacer />
                                <MudTooltip Text="Apply latest version">
                                    <MudIconButton Icon="@Icons.Material.Filled.Bolt"
                                                   Color="Color.Primary"
                                                   OnClick="() => ApplyLatest(item)" />
                                </MudTooltip>
                            </MudCardHeader>

                            <MudDivider />

                            <MudCardContent>
                                <MudStack Row="true" Spacing="1" Class="flex-wrap">
                                    @foreach (var version in item.Versions)
                                    {
                                        var pluginType = $"{item.Type}:{version}";
                                        <MudChip T="string" Clickable="true"
                                                 Variant="Variant.Outlined"
                                                 Size="Size.Small"
                                                 Color="Color.Default"
                                                 OnClick="() => OnItemClick.InvokeAsync(pluginType)">
                                            @version
                                        </MudChip>
                                    }
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        }
    </MudStack>
</MudPaper>

<style>
    .hover-card {
        transition: transform .15s ease, box-shadow .15s ease;
    }

    .hover-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--mud-elevation-6);
    }
</style>

@code {
    [Parameter] public EventCallback<string> OnItemClick { get; set; }

    private List<PluginTypeInfo> Items { get; set; } = new();
    private string _search = string.Empty;
    private bool _loading;

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        Items = await LoadPluginTypes(CancellationToken.None);
        _loading = false;
    }

    private List<PluginTypeInfo> FilteredItems =>
        string.IsNullOrWhiteSpace(_search)
            ? Items
            : Items
                .Where(i =>
                    i.Type.Contains(_search, StringComparison.OrdinalIgnoreCase) ||
                    i.Versions.Any(v => v.Contains(_search, StringComparison.OrdinalIgnoreCase)))
                .ToList();

    private async Task<List<PluginTypeInfo>> LoadPluginTypes(CancellationToken cancellationToken)
    {
        try
        {
            var token = await TokenProvider.GetAccessTokenAsync();
            FlowSynxClient.SetAuthenticationStrategy(
                new FlowSynx.Client.Authentication.BearerTokenAuthStrategy(token));

            var request = new FlowSynx.Client.Messages.Requests.Plugins.PluginsListRequest
            {
                Page = 1,
                PageSize = int.MaxValue
            };

            var result = await FlowSynxClient.Plugins.ListAsync(request, cancellationToken);

            if (result.StatusCode != 200 || !result.Payload.Succeeded)
            {
                SnackBar.Add("Failed to load plugins", Severity.Error);
                return new();
            }

            return result.Payload.Data
                .GroupBy(p => p.Type)
                .Select(g => new PluginTypeInfo
                {
                    Type = g.Key,
                    Versions = g.Select(x => x.Version)
                                .Distinct()
                                .OrderByDescending(v => v)
                                .ToList()
                })
                .ToList();
        }
        catch (Exception ex)
        {
            SnackBar.Add(ex.Message, Severity.Error);
            return new();
        }
    }

    private void ApplyLatest(PluginTypeInfo plugin)
    {
        var version = plugin.Versions.FirstOrDefault() ?? "latest";
        OnItemClick.InvokeAsync($"{plugin.Type}:{version}");
    }

    private class PluginTypeInfo
    {
        public string Type { get; set; } = string.Empty;
        public List<string> Versions { get; set; } = new();
    }
}