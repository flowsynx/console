@using FlowSynx.Client.Messages.Requests.Plugins
@using FlowSynx.Client.Messages.Responses.Plugins
@using MudBlazor

@attribute [Authorize]
@inject IAccessTokenProvider TokenProvider
@inject IFlowSynxClient FlowSynxClient
@inject ISnackbar SnackBar

<MudDialog MaxWidth="MaxWidth.Medium"
           FullWidth
           DisableBackdropClick="@IsProcessing"
           CloseOnEscapeKey="false">

    <TitleContent>
        <MudText Typo="Typo.h6">Workflow Configuration</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">
            Define execution behavior and error handling
        </MudText>
    </TitleContent>

    <DialogContent>

        <MudCard Elevation="0" Class="rounded-2xl">

            <!-- Tabs -->
            <MudTabs Rounded="true"
                     Outlined="true"
                     Border="true"
                     ApplyEffectsToContainer="true"
                     Centered="false"
                     Elevation="0"
                     Class="mb-4"
                     PanelClass="pa-6">

                <!-- GENERAL -->
                <MudTabPanel Text="General" Icon="@Icons.Material.Filled.Settings">
                    <MudGrid Spacing="3">
                        <MudItem xs="12">
                            <MudTextField T="string"
                                          @bind-Value="Config.Schema"
                                          Label="Workflow Schema"
                                          Placeholder="https://schema.flowsynx.io/workflows/v1.2.0/schema.flat.json"
                                          Variant="Variant.Filled"
                                          Margin="Margin.Dense"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Link"
                                          HelperText="Schema URL to provide a structured and consistent way to define workflow" />
                        </MudItem>

                        <MudItem xs="12">
                            <MudTextField T="string"
                                          @bind-Value="Config.Name"
                                          Label="Workflow Name"
                                          Required
                                          Variant="Variant.Filled"
                                          Margin="Margin.Dense"
                                          HelperText="Name of the workflow"/>
                        </MudItem>

                        <MudItem xs="12">
                            <MudTextField T="string"
                                          @bind-Value="Config.Description"
                                          Label="Description"
                                          Placeholder="Enter task description"
                                          HelperText="Description of the workflow"
                                          Lines="3"
                                          Variant="Variant.Filled" />
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <!-- EXECUTION -->
                <MudTabPanel Text="Execution" Icon="@Icons.Material.Filled.PlayArrow">
                    <MudGrid Spacing="3">
                        <MudItem xs="12" sm="6">
                            <MudNumericField T="int?"
                                             @bind-Value="Config.Configuration.DegreeOfParallelism"
                                             Label="Degree of Parallelism"
                                             Required
                                             Variant="Variant.Filled"
                                             Margin="Margin.Dense"
                                             HelperText="Maximum degree of parallelism" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudNumericField T="int?"
                                             @bind-Value="Config.Configuration.TimeoutMilliseconds"
                                             Label="Timeout (ms)"
                                             Required
                                             Variant="Variant.Filled"
                                             Margin="Margin.Dense"
                                             HelperText="Maximum workflow execution time" />
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <!-- ERROR HANDLING -->
                <MudTabPanel Text="Error Handling" Icon="@Icons.Material.Filled.WarningAmber">
                    <MudGrid Spacing="3">
                        @if (Config?.Configuration.ErrorHandling != null)
                        {
                            <MudItem xs="6">
                                <MudSelect @bind-Value="Config.Configuration.ErrorHandling.Strategy"
                                           Variant="Variant.Filled"
                                           Placeholder="Select error strategy"
                                           HelperText="Select the strategy to handle errors"
                                           Label="Error Strategy">
                                    @foreach (var strategy in Enum.GetValues<ErrorStrategy>())
                                    {
                                        <MudSelectItem Value="@strategy.ToString().ToLower()">
                                            @strategy
                                        </MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>

                            @if (Config?.Configuration.ErrorHandling?.Strategy?.ToLower() == "triggertask")
                            {
                                <MudItem xs="6">
                                    <MudTextField @bind-Value="Config.Configuration?.ErrorHandling?.TriggerPolicy!.TaskName"
                                                  Label="Trigger Task Name"
                                                  Placeholder="Enter task name to trigger"
                                                  HelperText="The name of the task to trigger on error"
                                                  Variant="Variant.Filled" />
                                </MudItem>
                            }
                        }
                    </MudGrid>
                </MudTabPanel>

                <!-- RETRY POLICY -->
                <MudTabPanel Text="Retry Policy" Icon="@Icons.Material.Filled.Refresh">
                    <MudGrid Spacing="3">
                        <MudItem xs="12" sm="6">
                            <MudNumericField T="int"
                                             @bind-Value="Config.Configuration.ErrorHandling!.RetryPolicy!.MaxRetries"
                                             Label="Max Retries"
                                             Variant="Variant.Filled"
                                             Margin="Margin.Dense"
                                             HelperText="Maximum number of retry attempts"/>
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudSelect T="string"
                                       @bind-Value="Config.Configuration.ErrorHandling!.RetryPolicy!.BackoffStrategy"
                                       Label="Backoff Strategy"
                                       Variant="Variant.Filled"
                                       Margin="Margin.Dense"
                                       HelperText="Select the backoff strategy">
                                @foreach (var strategy in Enum.GetValues<BackoffStrategy>())
                                {
                                    <MudSelectItem Value="@strategy.ToString().ToLower()">
                                        @strategy
                                    </MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudNumericField T="int"
                                             @bind-Value="Config.Configuration.ErrorHandling!.RetryPolicy!.InitialDelayMilliseconds"
                                             Label="Initial Delay (ms)"
                                             Variant="Variant.Filled"
                                             Margin="Margin.Dense"
                                             HelperText="Initial delay before the first retry"/>
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudNumericField T="int"
                                             @bind-Value="Config.Configuration.ErrorHandling!.RetryPolicy!.MaxDelayMilliseconds"
                                             Label="Max Delay (ms)"
                                             Variant="Variant.Filled"
                                             Margin="Margin.Dense"
                                             HelperText="Maximum delay between retries"/>
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudNumericField T="double"
                                             @bind-Value="Config.Configuration.ErrorHandling!.RetryPolicy!.BackoffCoefficient"
                                             Label="Backoff Coefficient"
                                             Variant="Variant.Filled"
                                             Margin="Margin.Dense"
                                             HelperText="Backoff coefficient for retry delays" />
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

            </MudTabs>

            <!-- Footer -->
            <MudDivider />

            <MudCardActions Class="pa-4 d-flex justify-end gap-3">
                <MudButton Variant="Variant.Text"
                           Disabled="@IsProcessing"
                           OnClick="Cancel">
                    Cancel
                </MudButton>

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Disabled="@IsProcessing"
                           OnClick="Save"
                           StartIcon="@Icons.Material.Filled.Save">
                    @if (IsProcessing)
                    {
                        <MudProgressCircular Indeterminate Size="Size.Small" Class="mr-2" />
                        <span>Saving…</span>
                    }
                    else
                    {
                        <span>Save Configuration</span>
                    }
                </MudButton>
            </MudCardActions>

        </MudCard>

    </DialogContent>
</MudDialog>


@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public WorkflowViewModel Config { get; set; } = new();

    private bool IsProcessing = false;

    private void Cancel() => MudDialog.Cancel();

    protected override void OnInitialized()
    {
        Config.Configuration.ErrorHandling ??= new ErrorHandling();
        Config.Configuration.ErrorHandling.RetryPolicy ??= new RetryPolicy();

        Config.Configuration.ErrorHandling ??= new ErrorHandling()
        {
            Strategy = ErrorStrategy.Abort.ToString().ToLower()
        };

        Config.Configuration.ErrorHandling.TriggerPolicy ??= new TriggerPolicy
        {
            TaskName = string.Empty
        };

        if (!string.IsNullOrWhiteSpace(Config.Configuration.ErrorHandling.Strategy))
        {
            Config.Configuration.ErrorHandling.Strategy = Config.Configuration.ErrorHandling.Strategy.ToLower();
        }

        if (!string.IsNullOrWhiteSpace(Config.Configuration.ErrorHandling!.RetryPolicy!.BackoffStrategy))
        {
            Config.Configuration.ErrorHandling!.RetryPolicy!.BackoffStrategy = Config.Configuration.ErrorHandling!.RetryPolicy!.BackoffStrategy.ToLower();
        }
    }

    private void Save()
    {
        try
        {
            IsProcessing = true;
            MudDialog.Close(DialogResult.Ok(Config));
        }
        catch (Exception)
        {
            // Handle any exceptions that may occur during the update process
        }
        finally
        {
            IsProcessing = false;
        }
    }

    public enum ErrorStrategy
    {
        Retry,
        Skip,
        Abort,
        TriggerTask
    }

    public enum BackoffStrategy
    {
        Fixed,
        Linear,
        Exponential,
        Jitter
    }
}